# Slackインシデント管理システム 実装タスクリスト

## Phase 1: 基本機能（プロジェクト初期設定とSlack連携）

### 1. プロジェクト初期設定
- [x] **Next.js 14プロジェクトの作成**
  - アクション: `npx create-next-app@latest slack-incident-app --typescript --tailwind --app`でプロジェクト作成
  - 達成条件: Next.js 14（App Router）のプロジェクトが正常に作成される
  - 確認方法: `npm run dev`でローカル開発サーバーが起動し、http://localhost:3000 でアクセス可能

- [x] **必要なパッケージのインストール**
  - アクション: 以下のパッケージをインストール
    - `@slack/bolt`: Slack連携
    - `@neondatabase/serverless`: PostgreSQL接続
    - `openai` または `@anthropic-ai/sdk`: LLM API
    - `zod`: バリデーション
    - `date-fns`: 日付処理
  - 達成条件: すべてのパッケージがpackage.jsonに追加され、エラーなくインストール完了
  - 確認方法: `npm list`でインストール済みパッケージを確認

- [x] **環境変数の設定**
  - アクション: `.env.local`ファイルを作成し、必要な環境変数を定義
    ```
    DATABASE_URL=
    SLACK_BOT_TOKEN=
    SLACK_SIGNING_SECRET=
    SLACK_APP_TOKEN=
    OPENAI_API_KEY= # or ANTHROPIC_API_KEY
    NEXT_PUBLIC_APP_URL=
    ```
  - 達成条件: すべての環境変数が定義され、`.gitignore`に`.env.local`が含まれている
  - 確認方法: 環境変数が正しく読み込めることをconsole.logで確認

### 2. データベース設定
- [x] **NEON PostgreSQLプロジェクトの作成**
  - アクション: NEONダッシュボードで新規プロジェクトを作成し、接続文字列を取得
  - 達成条件: DATABASE_URLが取得でき、`.env.local`に設定済み
  - 確認方法: データベース接続テストスクリプトで接続確認

- [x] **データベーススキーマの作成**
  - アクション: 設計書に基づいて以下のテーブルを作成
    - incidents テーブル
    - incident_messages テーブル
    - incident_reviews テーブル
  - 達成条件: すべてのテーブルとインデックスが正常に作成される
  - 確認方法: データベースクライアントで各テーブルの存在とスキーマを確認

- [x] **データベース接続ユーティリティの実装**
  - アクション: `/lib/db.ts`にNEON接続用のユーティリティ関数を実装
  - 達成条件: データベースへの接続とクエリ実行が可能
  - 確認方法: 簡単なSELECTクエリでテスト

### 3. Slack App設定
- [x] **Slack Appの作成と設定**
  - アクション: api.slack.comで新規Appを作成し、必要なOAuth Scopeを設定
    - channels:history
    - channels:read
    - chat:write
    - users:read
  - 達成条件: Bot User OAuth Tokenが取得でき、環境変数に設定済み
  - 確認方法: Slack APIテストエンドポイントでトークンの有効性確認

- [x] **Event Subscriptionsの設定**
  - アクション: Slack Appでイベントサブスクリプションを有効化し、以下を設定
    - message.channels（スレッドの返信も含む）
  - 達成条件: Request URLの検証が通り、イベントが有効化される
  - 確認方法: Slackチャンネルでメッセージとスレッド返信を投稿し、Webhookが受信される

- [x] **Slack Webhook受信エンドポイントの実装**
  - アクション: `/app/api/slack/events/route.ts`にPOSTエンドポイントを実装
  - 達成条件: Slack署名検証を含むWebhook受信が可能
  - 確認方法: Slackからのチャレンジリクエストに正常に応答

## Phase 2: LLM連携（障害検出機能）

### 4. LLM統合
- [x] **LLM APIクライアントの実装**
  - アクション: `/lib/llm.ts`にOpenAI/Claude APIクライアントを実装
  - 達成条件: プロンプトを送信してレスポンスを受け取れる
  - 確認方法: 簡単なテストプロンプトで動作確認

- [x] **障害判定ロジックの実装**
  - アクション: 設計書のプロンプトテンプレートを使用した判定関数を実装
  - 達成条件: Slackメッセージから障害判定結果（JSON）を取得できる
  - 確認方法: サンプルメッセージでの判定テスト

- [x] **信頼度スコア計算の実装**
  - アクション: LLMレスポンスから0.0-1.0の信頼度スコアを抽出・検証
  - 達成条件: 設計書の基準に基づいた信頼度が算出される
  - 確認方法: 各種パターンのメッセージでスコアの妥当性確認

### 5. メッセージ処理パイプライン
- [x] **Slackメッセージの保存処理**
  - アクション: 受信したメッセージをincident_messagesテーブルに保存
  - 達成条件: スレッドのメッセージが正しく保存される
  - 確認方法: データベースでメッセージデータを確認

- [x] **スレッド単位でのメッセージ収集**
  - アクション: thread_tsを使用してスレッド全体のメッセージを取得
  - 達成条件: 親メッセージと返信がすべて取得できる
  - 確認方法: Slack APIでスレッドメッセージを取得してDB保存

- [x] **インシデント自動登録機能**
  - アクション: LLM判定結果に基づいてincidentsテーブルに自動登録
  - 達成条件: 信頼度0.5以上の場合に自動でインシデント作成
  - 確認方法: テストメッセージでインシデントが作成されることを確認

## Phase 3: ダッシュボード（UI実装）

### 6. API Routes実装
- [x] **インシデント一覧取得API**
  - アクション: `/app/api/incidents/route.ts`にGETエンドポイント実装
  - 達成条件: status、confidence_min等のフィルタリングが機能
  - 確認方法: Postman/curlでAPIレスポンスを確認

- [x] **インシデント詳細取得API**
  - アクション: `/app/api/incidents/[id]/route.ts`にGETエンドポイント実装
  - 達成条件: インシデントIDで詳細情報とメッセージ履歴を取得
  - 確認方法: 実際のインシデントIDでデータ取得確認

- [x] **インシデント更新API**
  - アクション: `/app/api/incidents/[id]/route.ts`にPATCHエンドポイント実装
  - 達成条件: status、resolved_at等の更新が可能
  - 確認方法: ステータス変更が正しく反映されることを確認

- [x] **インシデントレビューAPI**
  - アクション: `/app/api/incidents/[id]/review/route.ts`にPOSTエンドポイント実装
  - 達成条件: レビュー情報がincident_reviewsテーブルに保存
  - 確認方法: レビュー投稿後のデータ確認

### 7. UIコンポーネント実装
- [x] **レイアウトとナビゲーション**
  - アクション: `/app/layout.tsx`と共通ヘッダーコンポーネントの実装
  - 達成条件: モダンでアクセシブルなUIレイアウトが表示される
  - 確認方法: 各画面でレイアウトが正しく表示される

- [x] **インシデント一覧画面**
  - アクション: `/app/page.tsx`にインシデント一覧テーブルを実装
  - 達成条件: フィルタリング機能付きの一覧が表示される
  - 確認方法: 各フィルタが正しく動作することを確認

- [x] **インシデント詳細画面**
  - アクション: `/app/incidents/[id]/page.tsx`に詳細表示画面を実装
  - 達成条件: Slackメッセージ履歴とLLM分析結果が表示される
  - 確認方法: 実際のインシデントで詳細情報が正しく表示

- [x] **編集・レビュー機能のUI**
  - アクション: インシデント詳細画面に編集フォームとレビュー機能を追加
  - 達成条件: インライン編集とレビュー投稿が可能
  - 確認方法: 編集・レビューが正しく保存される

### 8. フィルタリング機能
- [x] **ステータス別フィルタ**
  - アクション: Open/Resolved/Under Reviewのフィルタリングを実装
  - 達成条件: 各ステータスでの絞り込みが機能
  - 確認方法: フィルタ適用時の表示件数と内容を確認

- [x] **重要度・信頼度フィルタ**
  - アクション: severity_levelとconfidence_scoreでのフィルタリング実装
  - 達成条件: スライダーやセレクトボックスでの絞り込みが可能
  - 確認方法: 各値での絞り込み結果の妥当性確認

- [ ] **期間指定フィルタ**
  - アクション: 日付範囲選択によるフィルタリング実装
  - 達成条件: detected_atでの期間絞り込みが機能
  - 確認方法: 指定期間のインシデントのみ表示される

## Phase 4: 拡張機能

### 9. 統計ダッシュボード
- [x] **統計データ集計API**
  - アクション: `/app/api/statistics/route.ts`に集計エンドポイント実装
  - 達成条件: 月別件数、重要度分布、平均解決時間を返す
  - 確認方法: APIレスポンスのデータ妥当性確認

- [ ] **統計表示画面**
  - アクション: `/app/statistics/page.tsx`にグラフ表示を実装
  - 達成条件: Chart.js等でビジュアル表示される
  - 確認方法: 各種統計が正しく可視化される

- [ ] **頻出キーワード分析**
  - アクション: インシデントタイトル・説明から頻出キーワード抽出
  - 達成条件: 上位キーワードがランキング表示される
  - 確認方法: 実データでのキーワード抽出結果確認

### 10. 通知・エクスポート機能
- [ ] **Slack通知機能**
  - アクション: 高重要度インシデント検出時の自動通知実装
  - 達成条件: 指定チャンネルに通知メッセージが投稿される
  - 確認方法: テストインシデントでの通知確認

- [ ] **CSV/JSONエクスポート**
  - アクション: インシデント一覧のエクスポート機能実装
  - 達成条件: フィルタ適用後のデータがダウンロード可能
  - 確認方法: エクスポートファイルの内容確認

## デプロイ・運用準備

### 11. セキュリティ実装
- [ ] **Slack署名検証**
  - アクション: Webhookエンドポイントに署名検証ミドルウェア実装
  - 達成条件: 不正なリクエストが拒否される
  - 確認方法: 無効な署名でのリクエストテスト

- [ ] **認証機能の実装**
  - アクション: NextAuth.jsでダッシュボードの認証を実装
  - 達成条件: 未認証ユーザーがアクセスできない
  - 確認方法: ログイン前後のアクセス制御確認

- [ ] **レート制限の実装**
  - アクション: LLM APIコールにレート制限を実装
  - 達成条件: 過剰なAPIコールが制限される
  - 確認方法: 連続リクエストでの制限動作確認

### 12. Vercelデプロイ
- [ ] **Vercelプロジェクト設定**
  - アクション: Vercelにプロジェクトを作成し、環境変数を設定
  - 達成条件: ビルドが成功し、デプロイが完了
  - 確認方法: デプロイURLでアプリケーションが動作

- [ ] **本番環境での動作確認**
  - アクション: Slack Webhook URL更新と全機能の動作テスト
  - 達成条件: すべての機能が本番環境で正常動作
  - 確認方法: エンドツーエンドでの機能テスト

- [ ] **監視・ログ設定**
  - アクション: Vercel Analyticsとエラーログの設定
  - 達成条件: エラーとパフォーマンスが監視可能
  - 確認方法: ダッシュボードでメトリクス確認
